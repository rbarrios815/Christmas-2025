<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Christmas 2025 Sign-Up</title>
    <style>
      :root {
        --candy-red: #e63946;
        --evergreen: #0b8b62;
        --frost: #eef6ff;
        --gold: #f4a261;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at 20% 10%, rgba(255, 246, 235, 0.9), rgba(255, 255, 255, 0.4)),
          radial-gradient(circle at 80% 0%, rgba(228, 247, 255, 0.9), rgba(228, 247, 255, 0.2)),
          linear-gradient(135deg, #fef6f0 0%, #e3f6ff 45%, #f8efff 100%);
        margin: 0;
        padding: 16px;
        color: #1e2b2a;
        font-size: clamp(18px, 1.25rem, 20px);
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background-image: radial-gradient(rgba(255, 255, 255, 0.6) 1px, transparent 1px),
          radial-gradient(rgba(255, 255, 255, 0.4) 1px, transparent 1px);
        background-size: 18px 18px, 24px 24px;
        background-position: 0 0, 12px 12px;
        opacity: 0.55;
      }

      #app {
        max-width: 1040px;
        margin: 0 auto;
        width: 100%;
        position: relative;
      }

      .card {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(255, 248, 245, 0.96));
        border-radius: 18px;
        padding: 20px 22px;
        box-shadow: 0 8px 22px rgba(0, 0, 0, 0.14);
        margin-bottom: 16px;
        border: 2px solid rgba(230, 57, 70, 0.18);
        position: relative;
        overflow: hidden;
      }

      .personal-card {
        border: 2px solid rgba(11, 139, 98, 0.2);
        background: linear-gradient(180deg, rgba(248, 255, 250, 0.96), rgba(240, 252, 255, 0.96));
      }

      .card::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 18px;
        padding: 2px;
        background: repeating-linear-gradient(45deg, rgba(230, 57, 70, 0.35) 0, rgba(230, 57, 70, 0.35) 10px, rgba(11, 139, 98, 0.2) 10px, rgba(11, 139, 98, 0.2) 20px);
        -webkit-mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
      }

      .garland {
        display: flex;
        justify-content: center;
        gap: 6px;
        flex-wrap: wrap;
        margin-bottom: 8px;
        font-size: 1.1rem;
      }

      .garland span {
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }

      h1 {
        margin: 0 0 10px;
        font-size: 2.2rem;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--evergreen);
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      h2 {
        margin: 0 0 10px;
        font-size: 1.35rem;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #b83227;
      }

      .subtitle {
        font-size: 1rem;
        color: #2f3a39;
        margin-bottom: 10px;
      }

      .festive-banner {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(90deg, rgba(11, 139, 98, 0.08), rgba(244, 162, 97, 0.14));
        padding: 10px 14px;
        border-radius: 14px;
        font-weight: 700;
        color: #0b3a32;
        margin-bottom: 12px;
        border: 1px solid rgba(11, 139, 98, 0.2);
      }

      label {
        display: block;
        font-size: 1rem;
        margin: 8px 0 4px;
        color: #16302c;
      }

      input[type="text"],
      select {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 12px;
        border-radius: 12px;
        border: 2px solid rgba(11, 139, 98, 0.2);
        font-size: 1.05rem;
        background: rgba(255, 255, 255, 0.92);
      }

      input[type="text"]:focus,
      select:focus {
        outline: none;
        border-color: #e63946;
        box-shadow: 0 0 0 2px rgba(230, 57, 70, 0.16);
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .col-half {
        flex: 1 1 180px;
      }

      .age-group {
        display: flex;
        gap: 12px;
        align-items: center;
        margin: 6px 0 8px;
        font-size: 1rem;
      }

      .age-group label {
        display: flex;
        align-items: center;
        gap: 4px;
        margin: 0;
      }

      .votes {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
        font-size: 1rem;
      }

      .votes label {
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 0;
      }

      button {
        border-radius: 999px;
        border: none;
        padding: 12px 20px;
        font-size: 1.05rem;
        font-weight: 700;
        cursor: pointer;
        background: linear-gradient(90deg, var(--candy-red), var(--gold));
        color: #fff;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
        margin-top: 12px;
        transition: transform 120ms ease, box-shadow 120ms ease;
      }

      button:hover:not([disabled]) {
        transform: translateY(-1px) scale(1.01);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.2);
      }

      button[disabled] {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
      }

      #status {
        margin-top: 8px;
        font-size: 0.95rem;
      }

      #status.error {
        color: #b00020;
      }

      #status.ok {
        color: #006400;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.95rem;
        background: linear-gradient(135deg, #f1f5ff, #fff5f5);
        border: 1px solid #dde4ff;
        color: #0f3c2f;
      }

      #inviteTree ul,
      #foodList ul {
        list-style: none;
        padding-left: 16px;
        margin: 6px 0 0;
      }

      #inviteTree li,
      #foodList li {
        font-size: 1rem;
        margin: 4px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .inviter-group {
        margin-top: 8px;
        padding: 10px 12px;
        border-radius: 14px;
        background: linear-gradient(90deg, rgba(231, 248, 255, 0.92), rgba(247, 241, 255, 0.92));
        border: 1px dashed rgba(11, 139, 98, 0.25);
      }

      .personal-topline {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 6px;
      }

      .personal-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 999px;
        background: linear-gradient(120deg, rgba(11, 139, 98, 0.16), rgba(244, 162, 97, 0.18));
        color: #0c3f35;
        font-weight: 800;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      }

      .personal-note {
        font-size: 0.95rem;
        color: #224139;
      }

      .personal-tree-wrap {
        display: grid;
        grid-template-columns: minmax(220px, 1fr) minmax(240px, 1fr);
        gap: 14px;
        margin-top: 10px;
        align-items: start;
      }

      .personal-tree {
        position: relative;
        padding: 14px 14px 12px;
        border-radius: 16px;
        background: radial-gradient(circle at 40% 10%, rgba(255, 247, 210, 0.8), rgba(255, 255, 255, 0.9));
        border: 2px solid rgba(244, 162, 97, 0.25);
        box-shadow: inset 0 0 0 2px rgba(11, 139, 98, 0.12), 0 8px 16px rgba(0, 0, 0, 0.08);
      }

      .tree-star {
        width: 54px;
        height: 54px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ffd166, #f4a261);
        display: grid;
        place-items: center;
        font-size: 1.5rem;
        color: #7c3b00;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin: 0 auto 6px;
      }

      .tree-owner {
        text-align: center;
        font-weight: 800;
        color: #0c4c39;
        font-size: 1.05rem;
        margin-bottom: 8px;
      }

      .tree-branches {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 6px;
      }

      .tree-branches li {
        background: rgba(11, 139, 98, 0.08);
        border: 1px solid rgba(11, 139, 98, 0.2);
        border-radius: 12px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #0f372c;
        cursor: default;
      }

      .tree-branches li:hover {
        background: rgba(230, 57, 70, 0.08);
        border-color: rgba(230, 57, 70, 0.2);
      }

      .personal-actions {
        display: grid;
        gap: 8px;
      }

      .cluster-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        margin-top: 10px;
      }

      .tree-cluster {
        position: relative;
        padding: 12px 12px 10px;
        border-radius: 16px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(236, 252, 249, 0.96));
        border: 2px dashed rgba(11, 139, 98, 0.22);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      .tree-count {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e63946, #f4a261);
        color: #fff;
        display: grid;
        place-items: center;
        font-weight: 800;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      }

      .cluster-star {
        font-size: 1.25rem;
      }

      .cluster-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 800;
        color: #0c4c39;
        margin-bottom: 6px;
      }

      .cluster-branches {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .cluster-branches span {
        padding: 6px 10px;
        border-radius: 10px;
        background: rgba(11, 139, 98, 0.08);
        border: 1px solid rgba(11, 139, 98, 0.18);
        font-weight: 600;
        color: #0f372c;
        cursor: default;
      }

      .inviter-header {
        font-weight: 700;
        margin-bottom: 4px;
        font-size: 1rem;
        color: var(--evergreen);
      }

      .meta-line {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 1rem;
        align-items: center;
      }

      .meta-line span {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      #metaText {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .meta-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(11, 139, 98, 0.25);
        border-radius: 999px;
        padding: 6px 10px;
        font-weight: 700;
        color: #0c3f35;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .questions {
        font-size: 0.95rem;
        color: #2d3a3a;
        margin-top: 6px;
      }

      #foodNote {
        font-size: 0.9rem;
        color: #1f312e;
        margin-top: 4px;
      }

      @media (max-width: 600px) {
        body {
          padding: 10px;
        }
        .card {
          padding: 14px;
        }
        h1 {
          font-size: 2rem;
        }
        h2 {
          font-size: 1.25rem;
        }
        .row {
          flex-direction: column;
        }
        .personal-tree-wrap {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body onload="init()">
    <div id="app">
      <!-- Meta / header card -->
      <div class="card">
        <div class="garland" aria-hidden="true">
          <span>üß¶</span><span>‚ú®</span><span>üéÑ</span><span>ü¶å</span><span>üéÅ</span><span>‚òÉÔ∏è</span><span>üç™</span><span>‚ú®</span><span>üß¶</span>
        </div>
        <h1>üéÑ‚ú® Ho Ho Ho! Christmas 2025 ‚ú®üéÖ</h1>
        <div class="festive-banner">üéÖ Santa's Nice List is open ‚Äî add your name & your tastiest treat! üç™</div>
        <div class="meta-line">
          <span id="metaText"></span>
        </div>
        <div class="questions" id="questionsText"></div>
        <div class="subtitle">
          Add yourself, pick your age group, claim a food from the menu, and vote with festive thumbs-ups. The more names,
          the merrier the tree! üéÅ
        </div>
      </div>

      <!-- Personalized owner card (Your Name first) -->
      <div class="card personal-card">
        <div class="personal-topline">
          <div class="personal-chip" id="personalGreeting">üéÅ Start with <strong>Your Name</strong> so we can grow your own tree.</div>
          <div class="personal-note">We only show first name + last initial on this page.</div>
        </div>

        <label for="inviterInput">Your Name (Column K ‚ÄúEntered By‚Äù)</label>
        <input type="text" id="inviterInput" placeholder="Type your name to personalize the tree">

        <div class="personal-tree-wrap">
          <div>
            <div class="personal-tree" id="personalTree">
              <!-- filled by JS -->
            </div>
          </div>
          <div class="personal-actions">
            <button type="button" id="addGuestBtn" onclick="prepGuestAdd()" disabled>‚ûï Save your name to add guests</button>
            <div class="inviter-group" id="myInviteSummary">
              <div class="inviter-header">üéÅ Who you've invited so far</div>
              <div id="myInviteList" class="questions"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- RSVP / sign up card -->
      <div class="card">
        <h2>üìù RSVP & Food Signup üéÖ</h2>
        <div class="subtitle">
          Step 1) Enter <strong>Your Name</strong> above. Step 2) Tell us <strong>Who is attending?</strong> (full name for the sheet).
          Step 3) pick age, food, and one vote. Only first name + last initial will show on the page. ‚ú®
        </div>

        <label for="fullNameInput">Who is attending?</label>
        <div class="row">
          <div class="col-half">
            <input type="text" id="fullNameInput" placeholder="e.g., Ricky Barrios">
          </div>
          <div class="col-half" style="display:flex;align-items:center;gap:8px;">
            <span id="shortNamePreview" class="pill" style="display:none;"></span>
          </div>
        </div>

        <label for="ageSelect">Age group</label>
        <select id="ageSelect">
          <option value="">Select an age group</option>
          <option value="11+">11 or older</option>
          <option value="10-">10 or younger üéÅ</option>
        </select>

        <label for="foodSelect">Food signup (from the menu)</label>
        <select id="foodSelect">
          <option value="">-- I‚Äôm not bringing food yet --</option>
        </select>
        <div id="foodNote"></div>

        <div class="votes" role="group" aria-label="Vote for one option">
          <label>
            <input type="radio" name="voteChoice" id="voteGame" value="game">
            White Elephant game üéÅ (pick this OR cash)
          </label>
          <label>
            <input type="radio" name="voteChoice" id="voteCash" value="cash">
            $5‚Äì$10 cash donation for prizes üíµ (pick this OR White Elephant)
          </label>
          <label>
            <input type="radio" name="voteChoice" id="voteNone" value="none" checked>
            No vote yet
          </label>
        </div>

        <button type="button" id="saveBtn" onclick="handleSave()">üéÑ Save my spot</button>
        <div id="status"></div>
      </div>

      <!-- Invite tree -->
      <div class="card" id="inviteTree">
        <!-- Filled by JS -->
      </div>

      <!-- Food list -->
      <div class="card" id="foodList">
        <!-- Filled by JS -->
      </div>
    </div>

    <script>
      // Simple helper
      function $(id) {
        return document.getElementById(id);
      }

      let state = {
        meta: {},
        attendees: [],
        menu: [],
        currentRow: null
      };

      let lastSavedInviter = '';
      let lastHydratedName = '';

      function init() {
        showStatus('Loading‚Ä¶');
        google.script.run
          .withSuccessHandler(onDataLoaded)
          .withFailureHandler(onError)
          .getChristmasData();
      }

      function onDataLoaded(data) {
        state.meta = data.meta || {};
        state.attendees = enrichAttendees(data.attendees || []);
        state.menu = data.menu || [];
        state.currentRow = null;
        lastSavedInviter = '';

        renderMeta();
        renderInviteTree();
        renderFoodList();
        refreshFoodSelect();
        updateGuestButton();
        renderMyInvites();
        renderPersonalTree();

        showStatus('Loaded.', false);
      }

      function onError(err) {
        const msg = (err && err.message) ? err.message : String(err || 'Unknown error');
        showStatus(msg, true);
      }

      function showStatus(msg, isError) {
        const el = $('status');
        el.textContent = msg || '';
        el.className = '';
        if (!msg) return;
        el.classList.add(isError ? 'error' : 'ok');
      }

      function renderMeta() {
        const meta = state.meta || {};
        const metaLine = [];

        if (meta.date) {
          metaLine.push('üìÖ ' + meta.date);
        } else {
          metaLine.push('üìÖ 12/24');
        }

        if (meta.time) {
          metaLine.push('‚è∞ ' + meta.time);
        }

        if (meta.address) {
          metaLine.push('üìç ' + meta.address);
        }

        const metaEl = $('metaText');
        metaEl.innerHTML = '';
        metaLine.forEach(function(text) {
          const chip = document.createElement('span');
          chip.className = 'meta-chip';
          chip.textContent = text + ' ‚ú®';
          metaEl.appendChild(chip);
        });

        if (meta.questions) {
          $('questionsText').textContent = '‚ùì Questions for Santa‚Äôs helpers: ' + meta.questions;
        } else {
          $('questionsText').textContent = '';
        }
      }

      function ageEmoji(ageGroup) {
        // Christmasy emoji for 10 or younger
        if (ageGroup === '10-') return 'üß∏';
        return 'üéÑ';
      }

      function ageLabel(ageGroup) {
        if (ageGroup === '10-') return '10 or younger';
        if (ageGroup === '11+') return '11 or older';
        return 'Unknown age';
      }

      function enrichAttendees(list) {
        return (list || []).map(function(a) {
          return Object.assign({}, a, { shortName: a.shortName || toShortName(a.fullName || '') });
        });
      }

      function displayName(attendee) {
        if (!attendee) return '';
        return attendee.shortName || toShortName(attendee.fullName || '');
      }

      function refreshFoodSelect(selectedFood) {
        const select = $('foodSelect');
        select.innerHTML = '';

        // First option: none
        const noneOpt = document.createElement('option');
        noneOpt.value = '';
        noneOpt.textContent = "-- I‚Äôm not bringing food yet --";
        select.appendChild(noneOpt);

        // Build map: which menu item is taken and by whom
        const takenMap = {};
        (state.attendees || []).forEach(function(a) {
          if (!a.food) return;
          if (!takenMap[a.food]) takenMap[a.food] = [];
          takenMap[a.food].push(displayName(a));
        });

        (state.menu || []).forEach(function(item) {
          if (!item) return;
          const opt = document.createElement('option');
          opt.value = item;

          const takenBy = takenMap[item] || [];
          if (takenBy.length && item !== selectedFood) {
            opt.disabled = true;
            opt.textContent = item + ' ‚Äì taken by ' + takenBy.join(', ');
          } else {
            opt.textContent = item;
            if (selectedFood && item === selectedFood) {
              opt.selected = true;
            }
          }

          select.appendChild(opt);
        });

        const note = $('foodNote');
        if (!state.menu || !state.menu.length) {
          note.textContent = 'Menu will go in column J (starting J2). Once items are listed, you can claim one here.';
        } else {
          note.textContent = 'Items in gray (disabled) are already taken. Choose any available item.';
        }
      }

      function getSelectedAgeGroup() {
        return $('ageSelect').value;
      }

      function getVoteChoice() {
        const radios = document.querySelectorAll('input[name="voteChoice"]');
        for (let i = 0; i < radios.length; i++) {
          if (radios[i].checked) return radios[i].value;
        }
        return 'none';
      }

      function setVoteChoice(value) {
        const radios = document.querySelectorAll('input[name="voteChoice"]');
        radios.forEach(function(r) {
          r.checked = (r.value === value);
        });
      }

      function setAgeGroup(value) {
        $('ageSelect').value = value || '';
      }

      function updateShortNamePreview() {
        const fullName = $('fullNameInput').value.trim();
        const preview = $('shortNamePreview');
        if (!fullName) {
          preview.style.display = 'none';
          preview.textContent = '';
          return;
        }
        const shortName = toShortName(fullName);
        preview.textContent = shortName;
        preview.style.display = 'inline-flex';

        // Auto-load existing selections if this name already exists
        hydrateExistingSignup(fullName);
      }

      $('fullNameInput').addEventListener('input', function() {
        updateShortNamePreview();
        state.currentRow = null; // typing a new name resets current row
      });

      $('inviterInput').addEventListener('input', function() {
        lastSavedInviter = '';
        updateGuestButton();
        renderMyInvites();
        renderInviteTree();
      });

      function updateGuestButton() {
        const btn = $('addGuestBtn');
        if (!btn) return;
        if (lastSavedInviter) {
          btn.disabled = false;
          btn.textContent = 'üéÅ Invite someone under ' + toShortName(lastSavedInviter);
        } else {
          btn.disabled = true;
          btn.textContent = '‚ûï Save your name to add guests';
        }
      }

      function toShortName(fullName) {
        const parts = fullName.trim().split(/\s+/);
        if (!parts.length) return '';
        if (parts.length === 1) return parts[0];
        const first = parts[0];
        const last = parts[parts.length - 1];
        return first + ' ' + (last.charAt(0).toUpperCase() || '') + '.';
      }

      function currentInviterName() {
        return ($('inviterInput').value || lastSavedInviter || '').trim();
      }

      function hydrateExistingSignup(fullName) {
        if (!fullName) {
          lastHydratedName = '';
          state.currentRow = null;
          setAgeGroup('');
          setVoteChoice('none');
          refreshFoodSelect('');
          return;
        }

        const lookup = fullName.toLowerCase();
        const found = (state.attendees || []).find(function(a) {
          return (a.fullName || '').toLowerCase() === lookup;
        });

        if (!found) {
          if (lastHydratedName) {
            state.currentRow = null;
            setAgeGroup('');
            setVoteChoice('none');
            refreshFoodSelect('');
            lastHydratedName = '';
          }
          return;
        }

        state.currentRow = found.row;
        setAgeGroup(found.ageGroup || '');
        setVoteChoice(found.gameVote ? 'game' : found.cashVote ? 'cash' : 'none');
        $('inviterInput').value = found.enteredBy || found.fullName || '';
        refreshFoodSelect(found.food || '');
        lastSavedInviter = $('inviterInput').value.trim() || fullName;
        updateGuestButton();
        renderMyInvites();
        renderPersonalTree();

        if (lastHydratedName !== lookup) {
          showStatus('Loaded existing signup for ' + toShortName(fullName) + '. Update and save if needed.', false);
          lastHydratedName = lookup;
        }
      }

      function renderPersonalTree() {
        const treeEl = $('personalTree');
        const greeting = $('personalGreeting');
        if (!treeEl || !greeting) return;

        const inviterName = currentInviterName();
        const shortInviter = inviterName ? toShortName(inviterName) : '';

        greeting.innerHTML = inviterName
          ? '‚≠ê Welcome, <strong>' + shortInviter + '</strong>! Here‚Äôs your invite tree.'
          : 'üéÅ Start with <strong>Your Name</strong> so we can grow your own tree.';

        treeEl.innerHTML = '';

        if (!inviterName) {
          treeEl.innerHTML = '<p class="questions">Type your name above to preview your star + branches.</p>';
          return;
        }

        const matches = (state.attendees || []).filter(function(a) {
          return (a.enteredBy || '').toLowerCase() === inviterName.toLowerCase();
        });

        const selfEntry = (state.attendees || []).find(function(a) {
          return (a.fullName || '').toLowerCase() === inviterName.toLowerCase();
        });

        if (selfEntry && !matches.some(function(a) { return a.row === selfEntry.row; })) {
          matches.unshift(selfEntry);
        }

        if (!matches.length) {
          treeEl.innerHTML = '<p class="questions">Save yourself first, then add guests beneath your star.</p>';
          return;
        }

        const star = document.createElement('div');
        star.className = 'tree-star';
        star.textContent = '‚≠ê';
        treeEl.appendChild(star);

        const owner = document.createElement('div');
        owner.className = 'tree-owner';
        owner.textContent = shortInviter + ' ‚Ä¢ ' + matches.length + ' attending in your cluster';
        treeEl.appendChild(owner);

        const ul = document.createElement('ul');
        ul.className = 'tree-branches';

        matches
          .slice()
          .sort(function(a, b) { return displayName(a).localeCompare(displayName(b)); })
          .forEach(function(a) {
            const li = document.createElement('li');
            li.textContent = ageEmoji(a.ageGroup) + ' ' + displayName(a);
            li.title = 'Age: ' + ageLabel(a.ageGroup) + (a.food ? '\nFood: ' + a.food : '');
            li.addEventListener('click', function() {
              showStatus('Age for ' + displayName(a) + ': ' + ageLabel(a.ageGroup) + '. Edit above then save.', false);
            });
            ul.appendChild(li);
          });

        treeEl.appendChild(ul);
      }

      function renderMyInvites() {
        const listEl = $('myInviteList');
        if (!listEl) return;

        const inviterName = currentInviterName();
        if (!inviterName) {
          listEl.textContent = 'Type your name to see who is linked to you (Column K: Entered By).';
          renderPersonalTree();
          return;
        }

        const matches = (state.attendees || []).filter(function(a) {
          return (a.enteredBy || '').toLowerCase() === inviterName.toLowerCase();
        });

        if (!matches.length) {
          listEl.textContent = 'No guests linked yet. Save yourself, then add guests beneath you.';
          renderPersonalTree();
          return;
        }

        listEl.innerHTML = '';
        const ul = document.createElement('ul');

        matches
          .slice()
          .sort(function(a, b) {
            return displayName(a).localeCompare(displayName(b));
          })
          .forEach(function(a) {
            const li = document.createElement('li');
            li.textContent = ageEmoji(a.ageGroup) + ' ' + displayName(a);
            li.title = 'Age: ' + ageLabel(a.ageGroup) + (a.food ? '\nBringing: ' + a.food : '') +
              (a.gameVote ? '\nWhite Elephant: üëç' : a.cashVote ? '\nCash donation: üëç' : '') +
              '\nEntered by: ' + toShortName(inviterName);
            ul.appendChild(li);
          });

        listEl.appendChild(ul);
        renderPersonalTree();
      }

      function prepGuestAdd() {
        if (!lastSavedInviter) {
          showStatus('Save yourself first, then add guests beneath you.', true);
          return;
        }
        $('fullNameInput').value = '';
        updateShortNamePreview();
        $('inviterInput').value = lastSavedInviter;
        setAgeGroup('');
        setVoteChoice('none');
        refreshFoodSelect('');
        renderMyInvites();
        showStatus('Adding a guest under ' + toShortName(lastSavedInviter) + '. Enter their full name and details.', false);
      }

      function handleSave() {
        const name = $('fullNameInput').value.trim();
        if (!name) {
          showStatus('Please enter your full name.', true);
          return;
        }

        const ageGroup = getSelectedAgeGroup();
        if (!ageGroup) {
          showStatus('Please select your age group (11+ or 10-).', true);
          return;
        }

        const food = $('foodSelect').value;
        const inviter = $('inviterInput').value.trim() || name;
        const voteChoice = getVoteChoice();

        const lookup = name.toLowerCase();
        const existing = (state.attendees || []).find(function(a) {
          return (a.fullName || '').toLowerCase() === lookup;
        });
        if (existing) {
          state.currentRow = existing.row;
        }

        const payload = {
          row: state.currentRow,          // may be null/undefined if new
          fullName: name,
          ageGroup: ageGroup,
          food: food,
          gameVote: voteChoice === 'game',
          cashVote: voteChoice === 'cash',
          enteredBy: inviter             // first time this row is created, this is stored in column K
        };

        $('saveBtn').disabled = true;
        showStatus('Saving‚Ä¶');

        google.script.run
          .withSuccessHandler(function(data) {
            // Refresh state & UI using latest snapshot
            state.meta = data.meta || {};
            state.attendees = enrichAttendees(data.attendees || []);
            state.menu = data.menu || [];

            // keep the same name in the box
            const lookup = name.toLowerCase();
            const updated = state.attendees.find(function(a) {
              return (a.fullName || '').toLowerCase() === lookup;
            });
            state.currentRow = updated ? updated.row : null;

            renderMeta();
            renderInviteTree();
            renderFoodList();
            refreshFoodSelect(updated ? updated.food || '' : food || '');

            lastSavedInviter = inviter;
            updateGuestButton();
            renderMyInvites();
            renderPersonalTree();
            lastHydratedName = lookup;

            $('saveBtn').disabled = false;
            showStatus('Saved! üéÑ Add another guest under ' + toShortName(inviter || name) + ' when you‚Äôre ready.', false);
          })
          .withFailureHandler(function(err) {
            $('saveBtn').disabled = false;
            onError(err);
          })
          .saveAttendee(payload);
      }

      function renderInviteTree() {
        const container = $('inviteTree');
        container.innerHTML = '';

        const title = document.createElement('h2');
        title.innerHTML = 'üå≤ Santa‚Äôs Nice List (Invite Tree)';
        container.appendChild(title);

        if (!state.attendees || !state.attendees.length) {
          const p = document.createElement('p');
          p.textContent = 'No RSVPs yet ‚Äì be the first ornament on the tree! üéÄ';
          container.appendChild(p);
          return;
        }

        // Group by "Entered By" (column K)
        const groups = {};
        state.attendees.forEach(function(a) {
          const inviter = a.enteredBy || a.fullName || 'Host';
          if (!groups[inviter]) groups[inviter] = [];
          groups[inviter].push(a);
        });

        const personalInviter = currentInviterName().toLowerCase();
        const clusterWrap = document.createElement('div');
        clusterWrap.className = 'cluster-grid';

        const remainingInviters = Object.keys(groups)
          .sort()
          .filter(function(inviter) {
            return personalInviter ? inviter.toLowerCase() !== personalInviter : true;
          });

        if (!remainingInviters.length) {
          const p = document.createElement('p');
          p.textContent = 'Only your tree is showing above. As others join, their clusters will sprout here.';
          container.appendChild(p);
          return;
        }

        remainingInviters.forEach(function(inviter) {
          const card = document.createElement('div');
          card.className = 'tree-cluster';

          const count = document.createElement('div');
          count.className = 'tree-count';
          count.textContent = groups[inviter].length;
          card.appendChild(count);

          const header = document.createElement('div');
          header.className = 'cluster-header';
          header.innerHTML = '<span class="cluster-star">‚≠ê</span> <span>' + toShortName(inviter || 'Host') + '</span>';
          card.appendChild(header);

          const branches = document.createElement('div');
          branches.className = 'cluster-branches';

          groups[inviter]
            .slice()
            .sort(function(a, b) { return displayName(a).localeCompare(displayName(b)); })
            .forEach(function(a) {
              const span = document.createElement('span');
              span.textContent = ageEmoji(a.ageGroup) + ' ' + displayName(a);
              span.title = 'Age: ' + ageLabel(a.ageGroup) + (a.food ? '\nFood: ' + a.food : '');
              branches.appendChild(span);
            });

          card.appendChild(branches);
          clusterWrap.appendChild(card);
        });

        container.appendChild(clusterWrap);
      }

      function renderFoodList() {
        const container = $('foodList');
        container.innerHTML = '';

        const title = document.createElement('h2');
        title.innerHTML = 'üçΩÔ∏è Feast & Cookie Swap Lineup';
        container.appendChild(title);

        const attendees = (state.attendees || []).filter(function(a) {
          return !!a.food;
        });

        if (!attendees.length) {
          const p = document.createElement('p');
          p.textContent = 'No food signups yet. Once the menu (column J) is filled, pick a dish to bring and make Santa proud! üç∞';
          container.appendChild(p);
          return;
        }

        const list = document.createElement('ul');
        attendees
          .slice()
          .sort(function(a, b) {
            return (a.food || '').localeCompare(b.food || '');
          })
          .forEach(function(a) {
            const li = document.createElement('li');
            li.innerHTML =
              ageEmoji(a.ageGroup) +
              ' <strong>' + displayName(a) + '</strong> ‚Üí ' +
              a.food;
            li.title = (a.enteredBy ? 'Invited by: ' + toShortName(a.enteredBy) : '');
            list.appendChild(li);
          });

        container.appendChild(list);
      }
    </script>
  </body>
</html>
